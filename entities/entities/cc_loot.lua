AddCSLuaFile()

ENT.Type 			= "anim"
ENT.Base 			= "cc_base_ent"

ENT.Category		= "CombineControl"

ENT.Spawnable		= false
ENT.AdminSpawnable	= false

ENT.SearchTime 		= 3

ENT.Phrases 		= {
	"You fail to find anything useful.",
	"You don't find a single thing.",
	"The container has nothing inside.",
	"You fail to find a single useful thing.",
	"There's nothing of use left.",
	"There's nothing.",
	"Nothing.",
	"Empty.",
	"Already looted.",
	"It's empty.",
	"The container is empty.",
	"The container is looted already.",
	"It's empty, there's nothing here.",
	"Nothing. Nothing? ...nothing.",
	"After searching every nook and cranny, you find nothing.",
	"You make sure that each corner is carefully inspected before concluding that nothing is here.",
	"About ten minutes of fervent scavenging nets you a total of absolutely nothing.",
	"You desperately scrounge through the container. Nothing. Nothing? ...nothing. ",
	"This has already been cleared of anything of use.",
	"This is a desolate place and so is this container.",
	"You find a few worthless pieces of irradiated scrap. It's all thrown away.",
	"Your findings are insubstantial. Nothing here is usable.",
	"After a few minutes, it becomes pointless. There's nothing here and there hasn't been for years. ",
	"The container has already been stripped bare of its contents.",
	"Cleaned out of anything remotely useful.",
	"Cleaned out.",
	"Looted to the bone. Nothing here.",
	"Your search here is ineffective. Maybe you should look elsewhere.",
	"There's a hollowed-out hidey-hole in the container. It's already looted.",
	"Hollow. Empty. Barren. These words describe your findings within the container.",
	"You vacate the container of anything remotely tangible. Unfortunately, you found lint.",
	"You are exhaustive in your search. Nothing."
}

ENT.RarePhrases 	= {
	"This one is empty as well.",
	"Searching here is a waste of time. Not a goddamned thing in here.",
	"\"Holy fuck\", you think. You still haven't found anything.",
	"This location might have loot - unfortunately, it's not in this container.",
	"You manage to scrounge together a few pieces of lint to make a tiny tower. It falls apart.",
	"It's as barren as the wasteland outside of this city. You find nothing.",
	"You make a wish to find something useful... there's nothing inside.",
	"You hope that for whatever reason's brought you out of here, that searching this place is worth it. You don't find anything.",
	"You still haven't found anything useful.",
	"You find a piece of lint, it's thrown to the ground.",
	"You could have sworn there might've been something inside of here - unfortunately, there's nothing.",
	"Soon you're joined by the most dangerous of companions – an idea. Maybe using what you have, if anything, to take things from others is a more productive way of getting what you'd like.",
	"Soon you're joined by the most dangerous of companions – an idea. A drinking game between scavengers – every time you look somewhere, and you don't find something, you take a drink. You'd be drunk by now.",
	"To quote one of the greatest scavengers of the Americas: \"Mine.\" This container has already been looted of anything useful.",
	"Searching this place is futile. You are quick to recognize that bandits exist for a reason.",
	"Searching through these empty containers makes you think: \"Nothing has changed. But perhaps someday it will.\"",
	"While finding nothing in this container, far off there is music in the air. A whistled tune of raging melancholia. Unforgettable, until you pass it on.",
	"You find a note inside. You had some hope that there would be something useful here. The note is as follows: \"God is a creed outworn, Ill-wrought from a mirage fair | And life is an image pale | That faces a sunless morn.\"",
	"You find a note inside labeled with a faded name on top. You wonder why someone would go through all this trouble. It read: \"Then I got to my feet, and, taking my arms, he drew me out of my picture frame, into the darkness and the heat, to a place where the ground was frighteningly, thrillingly far away, and the sunless sky was burning and trembling all around us.\"",
	"You find a note inside. It read: \"There was now a distinct manifestation of morning in the air, and presently the bleared white visage of a sunless winter day emerged like a dead-born child.\"",
	"You find a note inside. This one only has a few words that you can read: \"Far away, to an infinite world I escape. I'm clear and calm, I'm unafraid. Sunless days...\" the rest fades out from there.",
	"You find a note inside. \"O wandering graves! O restless sleep! O silence of the sunless day! O still ravine! O stormy deep! Give up your prey! Give up your prey!\"",
	"Although you find nothing in this container, there is red graffiti nearby. \"WE GAVE OUR WORD THAT WE WOULD MAKE THEM GODS WE HAVE GIVEN OUR WORD. ERGO WE HAVE NOT KEPT OUR WORD.\""
}

ENT.SuperRarePhrases = {
	"You find some spare change. About nine cents. Unfortunately, it's all withered away by now.",
	"There's a shooting star high above... you make a wish. There's still nothing of use in here.",
	"There is a makeshift canteen inside filled with some strange liquid. You smell it... it's gone rank. The canteen is thrown out.",
	"You glance inside and pull out an object wrapped in plastic. The plastic is soiled and the object corroded. It's of no use.",
	"You look into the next crevice and find a small box. You open it up and find a note written by a stranger: \"In case anyone finds this, tell...\" - the rest is smudged out from years of neglect.",
	"There's a letter inside. The writing is weathered Latin barely legible, softly billowing in the wind. Its meaning is likely lost to time. Certainly it is beyond your current understanding.",
	"You pull out a white three-piece suit that's around your size. It rips open at the seams once exposed to the air - years of neglect finally catching up.",
	"You find a snow globe. Inside is a mournful figure of chipped glass, cracked and shining in the light. A depiction of a siren on a lake. She gazes at you with a quiet helplessness, beckoning you closer. The naked lady sits patiently as you complain about the gender politics of mythology, the unfortunate interplay of sexuality and vice, and the equal insult such things are to the males of the species treated as unthinking sexual omnivores and to the females reduced to mere passive decoration for the sake of such a tawdry social gaze. Why, for instance, is the succubus endlessly more represented than the incubus in all the literature? What does it say of the human condition that beauty has been linked to damnation by temptation from the moment of Eve's sin, and from where did the double-standards— It is a fine speech, even if in retrospect you remember that its only audience was actually a rock, a nearby raven, and a few old discarded bag of chips. \"SQUAWK\", it agrees, flying off to ponder things.",
	"You open the container. Out flies a raven that's been stuck inside for God knows how long – otherwise, it only left behind its droppings for you to scavenge. You close the container.",
	"Hours after searching for this container and finding nothing, you find somewhere safe and sleep. You are walking through a forest. The air is cold and dry, laden with the scent of pine. You reach the edge of the woods just as light rain begins to fall. Mist gathers fast; you can no longer even see the trees. You stop walking. A delicate thread of ice snakes down your spine and you shiver. This is a place with a long memory. You swear you've seen this place before.",
	"There is nothing here, as per usual. That night you dream of a tall building lit by cheery fires. A sign reads BE YE ALSO READY. The walls are wrong. The walls are wrong.",
	"Hours after searching for this container and finding nothing, you find yourself looking at a window at night. Candlelight near you allows you to see your reflection. You watch as your teeth begin to elongate: slowly, rather comfortably, like the growth of a tree branch in spring. You blink. It's all back to normal.",
	"This container has nothing in it. But a wall not too far away has a corkboard on it. It has a few messages pinned already for a local group called... you can't really read it, but the other messages run along the lines of \"This whole city is a tease\" and \"It looks like there's so much but there's nothing here\". You decide to add your own dissatisfaction by pinning a new message. You have marginally raised awareness of whatever your cause was, maybe.",
	"...an ache like a heartbreak that has had an eternity to turn septic. You find something here for once: Regret and longing. You yearn for an easier life, as everyone else does, but it never arrives. The night will get colder.",
	"The stars are writhing specks in the web that was the sky. From beneath the smog, it's hard to even identify the Northern Star of all things. Whether it's the evening or night, there's nothing beautiful about this world anymore. You wish that this container had something in it to finally wrong that right – but things are rarely fair now, are they?",
	"Of course, there is hunger under the sea, or on the surface, or in the skies. Inside of this container is a hidden stash of what is easily identified as half-cooked human meat. You feel unaccountably peckish but decline anyways. Perhaps the owner is still nearby.",
	"You find something written near this empty container. It takes you a few minutes, but you finally can read between the destroyed rubble and poor penmanship: If the Machine is Its master. Let the Sun be dr0wned. let the Currents rush in, the strange-winds and particle-trades, the Wave that Trembles and the great Curve. All of it, until there is dark."
}

ENT.RateLimitPhrases = {
	"Something tells you that you won't be finding anything for some time. Come back later.",
	"A little birdie told me that there are better ways to spend your time. You're unlikely to find anything anytime soon.",
	"A wave of lethargy washes over you as you once again don't find anything. Maybe you shouldn't spend all of your time searching for scraps.",
	"Nothing, nothing, it all turns up nothing. Maybe you'll have better luck tomorrow.",
	"You find a note inside. It reads: \"Stop hoarding all the loot to yourself, cunt.\" Maybe you should lay off for a while.",
	"This box doesn't contain anything either. You go to leave before a rustling sound startles you into action, maybe you should go somewhere safer.",
	"Minutes and hours start to blur together as you continually find yourself unable to get your hands on even the slightest bit of loot. The entire area's exhausted.",
	"A sudden realization snaps your consciousness back to reality. How long have you been here? When was the last time you found anything?",
	"You excitedly open the box to reveal an intact piece of clothing. Upon taking it out you realize you've been wearing it all this time. You need some rest.",
	"An hour passes within what feels like a minute, yet you still haven't found anything. You open the same box over and over again, expecting a different result. You should stop.",
	"You open the container. Inside of it is nothing but a black void, looking closer you can feel something staring back at you. You close the box and ask yourself how long you've gone without sleep.",
	"A thought crosses your mind as you close the empty container. When was the last time you interacted with someone?",
	"Inside the box is a small diary. Sitting down you start to read through it. It details the final regretful days of a scavenger that had let himself be taken over by greed. Pages upon pages tell stories of people, loved ones they had abandoned, sacrificed or even betrayed for their own gain. The story abruptly ends, you close the book. The faint smell of blood tickles your nostrils."
}

if SERVER then
	function ENT:Initialize()
		self:PhysicsInit(SOLID_VPHYSICS)
		self:SetMoveType(MOVETYPE_VPHYSICS)
		self:SetSolid(SOLID_VPHYSICS)

		self:SetUseType(SIMPLE_USE)

		self:GetPhysicsObject():EnableMotion(false)
	end

	function ENT:Use(ply)
		if ply:Team() != TEAM_CITIZEN then
			return
		end

		if self:IsBeingSearched() then
			if self.SearchPlayer != ply then
				ply:SendChat(nil, "ERROR", "Someone else is already searching through here!")
			end

			return
		end

		self.SearchPlayer = ply
		self.SearchPos = ply:GetPos()
		self.SearchFinish = CurTime() + self.SearchTime

		self:EmitSound("items/ammocrate_open.wav")

		ply:SendChat(nil, "WARNING", "Searching...")
	end

	function ENT:Think()
		if self.StoredItem and GAMEMODE.LootData.Disabled[self:GetLootPool()] then
			self.StoredItem = nil
		end

		if self.SearchFinish and not self:IsBeingSearched() then
			self:ClearSearch()
		end

		if self.SearchFinish and self.SearchFinish < CurTime() then
			self:FinishSearch()
		end
	end

	function ENT:ClearSearch(silent)
		if not silent then
			self:EmitSound("items/ammocrate_close.wav")

			if IsValid(self.SearchPlayer) then
				self.SearchPlayer:SendChat(nil, "ERROR", "Something interrupted your search!")
			end
		end

		self.SearchPlayer = nil
		self.SearchPos = nil
		self.SearchFinish = nil
	end

	function ENT:IsBeingSearched()
		if not self.SearchFinish then
			return false
		end

		return IsValid(self.SearchPlayer) and self.SearchPlayer:Alive() and self.SearchPlayer:GetPos():DistToSqr(self.SearchPos) < 5 * 5
	end

	function ENT:FinishSearch()
		local ply = self.SearchPlayer

		self:ClearSearch(true)
		self:EmitSound("items/ammocrate_close.wav")

		local stats = GAMEMODE.LootStats.Players[ply:SteamID()] or {
			Start = CurTime(),
			Last = CurTime(),
			Nick = ply:Nick(),
			Total = 0,
			Successful = 0,
			RateLimit = 0
		}

		stats.Last = CurTime()
		stats.Total = stats.Total + 1

		local rates = GAMEMODE.Loot.RateLimit

		if not ply.LootCharges then
			ply.LootCharges = rates.MaxAttempts
			ply.LastLoot = CurTime()
		end

		local increase = (CurTime() - ply.LastLoot) / rates.RechargeRate

		ply.LootCharges = math.Clamp(ply.LootCharges + increase, 0, rates.MaxAttempts)
		ply.LastLoot = CurTime()

		if ply.LootCharges < 1 then
			stats.RateLimit = stats.RateLimit + 1
			ply:SendChat(nil, "WARNING", table.Random(self.RateLimitPhrases), nil)

			return
		end

		ply.LootCharges = ply.LootCharges - 1

		if not self.StoredItem then
			local phrases = self.Phrases

			if math.random(1, 1000) == 1 then
				phrases = self.SuperRarePhrases
			elseif math.random(1, 100) == 1 then
				phrases = self.RarePhrases
			end

			ply:SendChat(nil, "WARNING", table.Random(phrases), nil)

			GAMEMODE.LootStats.Players[ply:SteamID()] = stats

			return
		end

		local amt = 1
		local override = GAMEMODE:GetDefaultItemKey(self.StoredItem, "LootAmount")

		if istable(override) then
			amt = math.random(override[1], override[2])
		elseif isnumber(override) then
			amt = override
		end

		ply:SendChat(nil, "WARNING", string.format("You found an item! (%s%s)",
			GAMEMODE:GetDefaultItemKey(self.StoredItem, "Name"),
			amt > 1 and " x" .. amt or ""
		))

		ply:GiveItem(self.StoredItem, amt, function(item)
			local pos = self:GetPos()

			GAMEMODE:WriteLog("item_loot", {
				Char = GAMEMODE:LogCharacter(ply),
				Item = GAMEMODE:LogItem(item),
				X = math.Round(pos.x, 2),
				Y = math.Round(pos.y, 2),
				Z = math.Round(pos.z, 2),
				Pool = self:GetLootPool()
			})

			if item.UseCondition and item.LootCondition then
				item:SetCondition(math.EasedFrac(math.random(), item.LootCondition[1], item.LootCondition[2], math.ease.InCubic))
			end
		end)

		self.StoredItem = nil

		stats.Successful = stats.Successful + 1

		GAMEMODE.LootStats.Players[ply:SteamID()] = stats
	end

	function ENT:RegisterWithLootPool(pool)
		self:SetLootPool(pool)

		GAMEMODE.LootData.Entities[pool] = GAMEMODE.LootData.Entities[pool] or {}
		GAMEMODE.LootData.Entities[pool][self] = true
	end

	function ENT:OnRemove()
		GAMEMODE.LootData.Entities[self:GetLootPool()][self] = nil
	end
end

function ENT:SetupDataTables()
	self:NetworkVar("String", 0, "LootPool")
end

function ENT:CanPhysgun()
	return false
end

function ENT:CanTool(ply)
	return false
end

if CLIENT then
	function ENT:Draw()
		self:DrawModel()

		if GAMEMODE.SeeAll and LocalPlayer():IsAdmin() then
			GAMEMODE:DrawWorldText(self:WorldSpaceCenter() + Vector(0, 0, self:BoundingRadius()), self:GetLootPool())
		end
	end
end
